version: 2.1

executors:
  golang:
    docker:
      - image: cimg/go:1.24
        environment:
          CSRF_TOKEN: 1234567890abcdef
          JWT_SECRET_KEY: AAAABBBBCCCCDDDD
          MONGO_HOST: 127.0.0.1
          MONGO_PORT: 27017
          MONGO_USER: root
          MONGO_PASS: example
          COMMON_KEY: commonkeyvalue12345
          API_BASE_URL: http://127.0.0.1:8880
          REDIS_ADDR: 127.0.0.1:6379
          REDIS_PASS: ""
          REDIS_DB: 0
      - image: mongo:latest
        environment:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: example
      - image: redis:latest
        environment:
          REDIS_PASSWORD: ""
          REDIS_DB: 0
  
commands:
  run_mongo:
    steps:
      - run:
          name: Wait for MongoDB
          command: dockerize -wait tcp://localhost:27017 -timeout 1m

  run_redis:
    steps:
      - run:
          name: Wait for Redis
          command: dockerize -wait tcp://localhost:6379 -timeout 1m

  run_tests_chat:
    steps:
      - run:
          name: Run Chat Service Tests
          command: |
            cd ./app
            go test -v -cover ./...

jobs:
  test:
    executor: golang
    steps:
      - checkout
      - run_mongo
      - run_redis
      - run_tests_chat

workflows:
  version: 2
  test_and_build:
    jobs:
      - test
